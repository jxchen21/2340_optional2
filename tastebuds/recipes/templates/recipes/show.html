{% extends 'base.html' %}
{% block content %}
{% load static %}
<div class="p-3">
  <div class="container">
    <div class="row mt-3">
      <div class="col-md-6 mb-3">
        <h2>{{ template_data.title }}</h2>
        
        <!-- Ratings Summary -->
        <div class="mb-4">
          <h4>Ratings & Reviews</h4>
          {% if template_data.avg_rating %}
            <div class="mb-2">
              <span class="h5">
                {% for i in "12345" %}
                  {% if forloop.counter <= template_data.avg_rating_int %}
                    <i class="fas fa-star text-warning"></i>
                  {% else %}
                    <i class="far fa-star text-warning"></i>
                  {% endif %}
                {% endfor %}
              </span>
              <span class="ms-2 h5">{{ template_data.avg_rating }}</span>
              <span class="text-muted">({{ template_data.rating_count }} rating{{ template_data.rating_count|pluralize }})</span>
            </div>
          {% else %}
            <p class="text-muted">No ratings yet. Be the first to rate this recipe!</p>
          {% endif %}
        </div>

        <h3>Ingredients</h3>
        <ul>
        {% for item in template_data.ingredients %}
            <li>{{ item.measure }} {{ item.ingredient }}</li>
        {% endfor %}
        </ul>
        <h3>Instructions</h3>
        <p>{{ template_data.instructions }}</p>
    </div>
    <div class="col-md-6 mx-auto mb-3 text-center">
        <img src="{{ template_data.recipe.strMealThumb }}"
            class="card-img-top rounded">
    </div>
  </div>

  <!-- Rating Form (for authenticated users) -->
  {% if user.is_authenticated %}
  <div class="row mt-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5>{% if template_data.user_rating %}Update Your Rating{% else %}Rate This Recipe{% endif %}</h5>
        </div>
        <div class="card-body">
          <form method="post" id="rating-form">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Rating</label>
              <div class="star-rating mb-2" id="star-rating">
                {% if template_data.user_rating %}
                  {% with current_rating=template_data.user_rating.rating %}
                  {% for i in "12345" %}
                    <i class="star-icon {% if forloop.counter <= current_rating %}fas fa-star{% else %}far fa-star{% endif %} text-warning" 
                       data-rating="{{ forloop.counter }}" 
                       style="font-size: 2rem; cursor: pointer; margin-right: 5px;"></i>
                  {% endfor %}
                  {% endwith %}
                {% else %}
                  {% for i in "12345" %}
                    <i class="star-icon far fa-star text-warning" 
                       data-rating="{{ forloop.counter }}" 
                       style="font-size: 2rem; cursor: pointer; margin-right: 5px;"></i>
                  {% endfor %}
                {% endif %}
              </div>
              {{ template_data.form.rating }}
              {% if template_data.form.rating.help_text %}
                <small class="form-text text-muted">{{ template_data.form.rating.help_text }}</small>
              {% endif %}
              {% if template_data.form.rating.errors %}
                <div class="text-danger">{{ template_data.form.rating.errors }}</div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label for="{{ template_data.form.comment.id_for_label }}" class="form-label">
                {{ template_data.form.comment.label }}
              </label>
              {{ template_data.form.comment }}
              {% if template_data.form.comment.errors %}
                <div class="text-danger">{{ template_data.form.comment.errors }}</div>
              {% endif %}
            </div>
            <button type="submit" class="btn btn-primary" id="submit-rating-btn">
              {% if template_data.user_rating %}Update Rating{% else %}Submit Rating{% endif %}
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="row mt-4">
    <div class="col-md-8">
      <div class="alert alert-info">
        <a href="{% url 'accounts.login' %}" class="alert-link">Login</a> or 
        <a href="{% url 'accounts.signup' %}" class="alert-link">Sign Up</a> to rate this recipe!
      </div>
    </div>
  </div>
  {% endif %}

  <!-- All Reviews -->
  <div class="row mt-4">
    <div class="col-md-10">
      <h4>Reviews</h4>
      {% if template_data.ratings %}
        {% for rating in template_data.ratings %}
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <strong>{{ rating.user.username }}</strong>
                  <span class="text-muted ms-2">
                    {{ rating.created_at|date:"F d, Y" }}
                    {% if rating.updated_at != rating.created_at %}
                      <small>(updated {{ rating.updated_at|date:"F d, Y" }})</small>
                    {% endif %}
                  </span>
                </div>
                <div>
                  {% for i in "12345" %}
                    {% if forloop.counter <= rating.rating %}
                      <i class="fas fa-star text-warning"></i>
                    {% else %}
                      <i class="far fa-star text-warning"></i>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
              {% if rating.comment %}
                <p class="mb-0">{{ rating.comment }}</p>
              {% else %}
                <p class="text-muted mb-0"><em>No comment provided</em></p>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No reviews yet. Be the first to review this recipe!</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const starRating = document.getElementById('star-rating');
  const ratingInput = document.getElementById('rating-value');
  
  // Only initialize if rating form exists (user is authenticated)
  if (!starRating || !ratingInput) {
    return;
  }
  
  const stars = starRating.querySelectorAll('.star-icon');
  
  // Get initial rating value if user has already rated
  {% if template_data.user_rating %}
    const initialRating = {{ template_data.user_rating.rating }};
    ratingInput.value = initialRating;
  {% endif %}
  
  // Handle star click
  stars.forEach(star => {
    star.addEventListener('click', function() {
      const rating = parseInt(this.getAttribute('data-rating'));
      ratingInput.value = rating;
      updateStars(rating);
    });
    
    // Handle hover for visual feedback
    star.addEventListener('mouseenter', function() {
      const rating = parseInt(this.getAttribute('data-rating'));
      highlightStars(rating);
    });
  });
  
  // Reset to selected value when mouse leaves
  starRating.addEventListener('mouseleave', function() {
    const currentRating = parseInt(ratingInput.value) || 0;
    updateStars(currentRating);
  });
  
  // Validate form submission
  const form = document.getElementById('rating-form');
  const submitBtn = document.getElementById('submit-rating-btn');
  
  form.addEventListener('submit', function(e) {
    if (!ratingInput.value || parseInt(ratingInput.value) < 1) {
      e.preventDefault();
      alert('Please select a rating by clicking on the stars.');
      return false;
    }
  });
  
  function updateStars(rating) {
    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.remove('far');
        star.classList.add('fas');
      } else {
        star.classList.remove('fas');
        star.classList.add('far');
      }
    });
  }
  
  function highlightStars(rating) {
    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.remove('far');
        star.classList.add('fas');
        star.style.color = '#ffc107'; // Bootstrap warning color
      } else {
        star.classList.remove('fas');
        star.classList.add('far');
        star.style.color = '#ffc107';
      }
    });
  }
});
</script>
{% endblock content %}